<head>
  <style> body { margin: 0; } </style>
  <script src="https://unpkg.com/force-graph"></script>
</head>

<body>
  <div id="graph"></div>

  <script>
    function transformSourceToTarget(sourceData) {
      const targetData = { nodes: [], links: [] };
      const tagToNodeId = new Map();
      let nextNodeId = 0;

      if (Array.isArray(sourceData)) {
        sourceData.forEach(item => {
          if (item.id !== undefined) {
            // For URL nodes, assign to group 2
            targetData.nodes.push({
              id: `url-${item.id}`,
              group: 2,
              type: 'url',
              label: item.title
            });

            if (Array.isArray(item.tags)) {
              item.tags.forEach(tag => {
                let tagNodeId;
                if (tagToNodeId.has(tag.id)) {
                  tagNodeId = tagToNodeId.get(tag.id);
                } else {
                  tagNodeId = `tag-${nextNodeId++}`;
                  tagToNodeId.set(tag.id, tagNodeId);
                  // For tag nodes, assign to group 1
                  targetData.nodes.push({
                    id: tagNodeId,
                    group: 1,
                    type: 'tag',
                    label: tag.name
                  });
                }

                targetData.links.push({
                  source: `url-${item.id}`,
                  target: tagNodeId,
                  value: 1
                });
              });
            }
          }
        });
      }

      return targetData;
    }

    fetch('shioridb.json')
      .then(response => response.json())
      .then(sourceData => {
        const data = transformSourceToTarget(sourceData);
        const Graph = ForceGraph();
        Graph(document.getElementById('graph'))
          .graphData(data)
          .nodeId('id')
          .nodeVal(node => node.val || 5)
          .nodeLabel(node => node.label)
          .nodeAutoColorBy('group')
          .linkSource('source')
          .linkTarget('target')
          .onNodeClick(node => {
            // Center/zoom on node
            Graph.centerAt(node.x, node.y, 1000);
            Graph.zoom(8, 2000);
          });
      })
      .catch(error => console.error('Error loading the data:', error)); // Moved catch() here
  </script>
</body>